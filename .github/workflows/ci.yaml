name: CloudFormation CI Pipeine (Reusable)
description: |
  This is a reusable GitHub Actions workflow for CI/CD using CloudFormation.
  It includes steps for linting, validating, scanning, and building AWS resources.
  The workflow is designed to be triggered by other workflows or manually.
  It also includes steps for checking environments, detecting changes, and preparing builds.

on:
  workflow_call:
    inputs:
      environment:
        description: "Environment to deploy to (e.g., dev, prod)."
        required: true
        type: string
        default: ci
      cfn-template-file:
        description: "CloudFormation template file name."
        required: true
        type: string
        default: "root-stack-template.yaml"
      cfn-params-file:
        description: "CloudFormation parameters file."
        required: true
        type: string
        default: "./cfn/params/cfn-parameters.json"
      snyk-token:
        description: "Snyk token for authentication."
        required: false
        type: string
    secrets:
      aws-role-arn:
        description: "AWS role ARN for assuming a role."
        required: true


permissions:
  id-token: write

jobs:
  check-environments:
    name: ğŸ” Check Environments ğŸ¥‚
    runs-on: ubuntu-latest
    steps:
      - name: Check Available Environments
        id: check
        uses: subhamay-bhattacharyya-gha/check-environments-action@main
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

  check-branch-issue:
    name: ğŸ” Branch Issue ğŸ¥‚
    runs-on: ubuntu-latest
    steps:
      - name: Verify branch issue
        id: branch-issue
        uses: subhamay-bhattacharyya-gha/branch-issue-action@main

        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Print Outputs
        run: |
          echo "Branch Issue: ${{ steps.branch-issue.outputs.issue-number }}"
          echo "Branch Issue: ${{ steps.branch-issue.outputs.issue-exists }}"

  detect-changes:
    name: ğŸ” Detect Repo Changes ğŸ¥‚
    runs-on: ubuntu-latest
    outputs:
      files-changed: ${{ steps.repo-changes.outputs.files-changed }}
      json-output: ${{ steps.repo-changes.outputs.json-output }}
      has-changes: ${{ steps.repo-changes.outputs.has-changes }}

    steps:
      - name: Detect repository changes
        id: repo-changes
        uses: subhamay-bhattacharyya-gha/list-updated-files-action@main

  detect-services:
    name: ğŸ” Detect Services ğŸ¥‚
    runs-on: ubuntu-latest
    outputs:
      services-used: ${{ steps.scan.outputs.services-used }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Scan AWS Services
        id: scan
        uses: subhamay-bhattacharyya-gha/scan-aws-services-action@main

      - name: Save Detected Services to Environment Variable
        run: |
          echo "Detected Services: ${{ steps.scan.outputs.services-used }}"
          echo 'SERVICES_USED=${{ steps.scan.outputs.services-used }}' >> $GITHUB_ENV

      - name: Print AWS Service Detection Table
        run: |
          echo "## AWS Services Detected" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service               | Used |" >> $GITHUB_STEP_SUMMARY
          echo "|------------------------|------|" >> $GITHUB_STEP_SUMMARY

          node -e "
            try {
              const result = JSON.parse(process.env.SERVICES_USED);
              const emoji = (val) => val ? 'âœ…' : 'âŒ';
              const rows = Object.entries(result)
                .map(([key, val]) => \`| \${key.padEnd(22)} | \${emoji(val)} |\`)
                .join('\n');
              console.log(rows);
            } catch (e) {
              console.error('âŒ Failed to parse SERVICES_USED:', e.message);
              process.exit(1);
            }
          " >> $GITHUB_STEP_SUMMARY

  execution-path:
    name: ğŸ” Determine Execution Path ğŸš§
    runs-on: ubuntu-latest
    needs: [check-environments, check-branch-issue, detect-services, detect-changes]
    steps:
      - name: Determine services used and repo changes
        run: |
          echo "Determine execution path"
          echo "## Execution Path" >> $GITHUB_STEP_SUMMARY
          echo "${{ needs.detect-changes.outputs.json-output }}" | base64 -d | jq . > ${{ github.workspace }}/repo-changes.json
          echo "${{ needs.detect-services.outputs.services-used }}"| sed -E 's/([{,])([^:{]+):/\1"\2":/g'|jq . > ${{ github.workspace }}/services-used.json
          # echo "Has changes: ${{ needs.detect-changes.outputs.has-changes }}"

      - name: Determine Execution Path
        id: determine-path
        run: |
          echo "Determine execution path"
          cat ${{ github.workspace }}/repo-changes.json
          echo "-------------------------------------------------------"
          cat ${{ github.workspace }}/services-used.json
          echo "-------------------------------------------------------"

  cfn-lint:
    name: ğŸ“‹ CFN Lint ğŸ¥‚
    runs-on: ubuntu-latest
    needs: [execution-path, detect-services, detect-changes]
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Lint CloudFormation templates
        uses: subhamay-bhattacharyya-gha/cfn-lint-action@feature/SB-0001-initial-release
        with:
          template-dir: 'cfn'           # Optional, default is '.'
          fail-on-warnings: 'true'      # Optional, default is 'false'

  cfn-validate:
    name: âœ”ï¸ CFN Validate ğŸ¥‚
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    needs: [execution-path, detect-services, detect-changes]
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: ${{ secrets.aws-role-arn }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Run CloudFormation Validation
        id: validate
        uses: subhamay-bhattacharyya-gha/cfn-validate-action@feature/SB-0001-initial-release
        with:
          template-dir: cfn
          cfn-template-file: ${{ inputs.cfn-template-file }}
          region: ${{ vars.AWS_REGION }}

      - name: Display Status
        run: |
          echo "Validation Status: ${{ steps.validate.outputs.status }}"
          # echo "Validation Message: ${{ steps.validate.outputs.message }}"
          echo "## CloudFormation Template Validation Status" >> $GITHUB_STEP_SUMMARY
          echo "Validation Status: ${{ steps.validate.outputs.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

  checkov-scan:
    name: ğŸ§³ Checkov Scan ğŸš§
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    needs: [execution-path, detect-services, detect-changes]
    steps:
      - name: Checkout Code
        uses: subhamay-bhattacharyya-gha/cfn-validate-scan-action@main
        with:
          aws-role-arn: ${{ secrets.aws-role-arn }}
          aws-region: ${{ vars.AWS_REGION }}
          template-dir: cfn
          template-file: root-stack-template.yaml
          iac-framework: cloudformation
          soft-fail: true
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“‹ Summarize and Print Checkov Scan Report with Snippets
        uses: subhamay-bhattacharyya-gha/checkov-report-action@main

  snyk-scan:
    name: ğŸ§¾ Snyk IaC Scan ğŸš§
    runs-on: ubuntu-latest
    needs: [execution-path, detect-services, detect-changes]
    # env:
    #   SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
    #   SNYK_ORG_ID: ${{ secrets.SNYK_ORGANIZATION_ID }}
    steps:
      - name: Snyk Scan
        run: echo "Snyk Scan"

  guard-rail:
    name: ğŸ’‚ğŸ»â€â™€ï¸ Infra Guard Rail ğŸš§
    runs-on: ubuntu-latest
    needs: [execution-path, detect-services, detect-changes]
    steps:
      - name: Guardrail
        run: echo "Guard Rail"

  build-lambda:
    name: ğŸ› ï¸ Lambda Package ğŸš§
    runs-on: ubuntu-latest
    # if: ${{ inputs.lambda == true }}
    needs: [execution-path, detect-services, detect-changes]
    steps:
      - name: Build Lambda Package
        run: echo "Building Lambda package..."

  build-lambda-layer:
    name: ğŸ› ï¸ Lambda Layer ğŸš§
    runs-on: ubuntu-latest
    # if: ${{ inputs.lambda == true }}
    needs: [execution-path, detect-services, detect-changes]
    steps:
      - name: Build Lambda Layer
        run: echo "Building Lambda layer..."

  build-glue:
    name: ğŸ› ï¸ Glue Script ğŸš§
    runs-on: ubuntu-latest
    # if: ${{ inputs.glue == true }}
    needs: [execution-path, detect-services, detect-changes]
    steps:
      - name: Package Glue Script
        run: echo "Packaging Glue script..."

  build-state-machine:
    name: ğŸ› ï¸ State Machine ğŸš§
    runs-on: ubuntu-latest
    # if: ${{ inputs.state-machine == true }}
    needs: [execution-path, detect-services, detect-changes]
    steps:
      - name: Deploy State Machine
        run: echo "Deploying State Machine..."

  ci-build:
    name: ğŸ“¦ CI Build ğŸš§
    runs-on: ubuntu-latest
    if: always()
    needs:
      - cfn-lint
      - cfn-validate
      - checkov-scan
      - snyk-scan
      - guard-rail
      - build-lambda
      - build-lambda-layer
      - build-glue
      - build-state-machine
    steps:
      - name: Finalize CI Build
        run: echo "CI build completed regardless of individual builds."

  infra-cost:
    name: ğŸ’° Infra Cost ğŸš§
    runs-on: ubuntu-latest
    if: always()
    needs: ci-build
    steps:
      - name: Determine Infra Cost
        run: echo "Determine Infra Cost."

  release-button:
    name: ğŸš€ Create Release ğŸš§
    runs-on: ubuntu-latest
    if: always()
    needs: infra-cost
    steps:
      - name: Create Release
        run: echo "Create Release Button."
