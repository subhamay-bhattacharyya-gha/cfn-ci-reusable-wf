name: CloudFormation CI Pipeine (Reusable)
description: |
  This is a reusable GitHub Actions workflow for CI/CD using CloudFormation.
  It includes steps for linting, validating, scanning, and building AWS resources.
  The workflow is designed to be triggered by other workflows or manually.
  It also includes steps for checking environments, detecting changes, and preparing builds.

on:
  workflow_call:
    inputs:
      environment:
        description: "Environment to deploy to (e.g., dev, prod)."
        required: true
        type: string
        default: ci
      cfn-template-file:
        description: "CloudFormation template file name."
        required: true
        type: string
        default: "root-stack-template.yaml"
      cfn-params-file:
        description: "CloudFormation parameters file."
        required: true
        type: string
        default: "./cfn/params/cfn-parameters.json"
      snyk-token:
        description: "Snyk token for authentication."
        required: false
        type: string


permissions:
  id-token: write

jobs:
  check-environments:
    name: ğŸ” Check Environments
    runs-on: ubuntu-latest
    steps:
      - name: Check Available Environments
        id: check
        uses: subhamay-bhattacharyya-gha/check-environments-action@main
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

  check-branch-issue:
    name: ğŸ” Branch Issue
    runs-on: ubuntu-latest
    steps:
      - name: Verify branch issue
        id: branch-issue
        uses: subhamay-bhattacharyya-gha/branch-issue-action@main
        
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Print Outputs
        run: |
          echo "Branch Issue: ${{ steps.branch-issue.outputs.issue-number }}"
          echo "Branch Issue: ${{ steps.branch-issue.outputs.issue-exists }}"


  repo-changes:
    name: ğŸ” Detect Repo Changes
    runs-on: ubuntu-latest
    steps:
      - name: Checkout with sufficient history
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
    
      - name: Print and store changed files with status JSON
        id: changed-files
        run: |
          echo "Fetching remote default branch..."
          git fetch origin
      
          DEFAULT_BRANCH=$(git symbolic-ref refs/remotes/origin/HEAD | sed 's@^refs/remotes/origin/@@')
      
          echo "List of changed files with status (A=Added, M=Modified, D=Deleted):"
          if git diff --name-status origin/$DEFAULT_BRANCH > changed_files.txt 2>/dev/null; then
            cat changed_files.txt
          else
            echo "Could not get diff with default branch â€” using diff-tree fallback."
            git diff-tree --no-commit-id --name-status -r HEAD > changed_files.txt
            cat changed_files.txt
          fi
      
          echo "==============================================="
      
          if [ ! -s changed_files.txt ]; then
            echo "No changed files detected. Skipping further steps."
            echo "files=" >> "$GITHUB_OUTPUT"
            echo '{ "A": [], "M": [], "D": [] }' > changed_files.json
            exit 0
          fi
      
          echo "Generating changed_files.json..."
          awk '
          BEGIN {
            print "{"
            added = modified = deleted = ""
          }
          {
            status = $1
            file = $2
            if (status == "A") added = added "\"" file "\","
            else if (status == "M") modified = modified "\"" file "\","
            else if (status == "D") deleted = deleted "\"" file "\","
          }
          END {
            if (length(added)) added = substr(added, 1, length(added)-1)
            if (length(modified)) modified = substr(modified, 1, length(modified)-1)
            if (length(deleted)) deleted = substr(deleted, 1, length(deleted)-1)
            print "  \"A\": [" added "],"
            print "  \"M\": [" modified "],"
            print "  \"D\": [" deleted "]"
            print "}"
          }' changed_files.txt > changed_files.json
      
          cat changed_files.json
      
          FILE_LIST=$(cut -f2 changed_files.txt | paste -sd ',' -)
          echo "files=$FILE_LIST" >> "$GITHUB_OUTPUT"
        
   detect-services:
    name: ğŸ” Detect Services
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Scan AWS Services
        id: scan
        uses: subhamay-bhattacharyya-gha/scan-aws-services-action@main

      - name: Save Detected Services to Environment Variable
        run: |
          echo "Detected Services: ${{ steps.scan.outputs.services-used }}"
          echo 'SERVICES_USED=${{ steps.scan.outputs.services-used }}' >> $GITHUB_ENV
        
      - name: Print AWS Service Detection Table
        run: |
          echo "## AWS Services Detected" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service               | Used |" >> $GITHUB_STEP_SUMMARY
          echo "|------------------------|------|" >> $GITHUB_STEP_SUMMARY

          node -e "
            try {
              const result = JSON.parse(process.env.SERVICES_USED);
              const emoji = (val) => val ? 'âœ…' : 'âŒ';
              const rows = Object.entries(result)
                .map(([key, val]) => \`| \${key.padEnd(22)} | \${emoji(val)} |\`)
                .join('\n');
              console.log(rows);
            } catch (e) {
              console.error('âŒ Failed to parse SERVICES_USED:', e.message);
              process.exit(1);
            }
          " >> $GITHUB_STEP_SUMMARY
  

  cfn-lint:
    name: ğŸ“‹ CFN Lint
    runs-on: ubuntu-latest
    needs:
      [check-environments, check-branch-issue, repo-changes, detect-services]
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

  cfn-validate:
    name: âœ”ï¸ CFN Validate
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    needs:
      [check-environments, check-branch-issue, repo-changes, detect-services]
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION }}

  checkov-scan:
    name: ğŸ§³ Checkov Scan
    runs-on: ubuntu-latest
    needs:
      [check-environments, check-branch-issue, repo-changes, detect-services]
    steps:
      - name: Checkout Code
        run: echo "Checkov Scan"

  snyk-scan:
    name: ğŸ§¾ Snyk IaC Scan
    runs-on: ubuntu-latest
    needs:
      [check-environments, check-branch-issue, repo-changes, detect-services]
    # env:
    #   SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
    #   SNYK_ORG_ID: ${{ secrets.SNYK_ORGANIZATION_ID }}
    steps:
      - name: Snyk Scan
        run: echo "Snyk Scan"

  guard-rail:
    name: ğŸ’‚ğŸ»â€â™€ï¸ Infra Guard Rail
    runs-on: ubuntu-latest
    needs:
      [check-environments, check-branch-issue, repo-changes, detect-services]
    steps:
      - name: Guardrail
        run: echo "Guard Rail"

  prepare-builds:
    name: ğŸ› ï¸ Prepare Build Jobs
    runs-on: ubuntu-latest
    needs:
      - cfn-lint
      - cfn-validate
      - checkov-scan
      - snyk-scan
      - guard-rail
    steps:
      - name: Preparation Complete
        run: echo "Build jobs can now run."

  build-lambda:
    name: ğŸ› ï¸ Lambda Package
    runs-on: ubuntu-latest
    # if: ${{ inputs.lambda == true }}
    needs: prepare-builds
    steps:
      - name: Build Lambda Package
        run: echo "Building Lambda package..."

  build-lambda-layer:
    name: ğŸ› ï¸ Lambda Layer
    runs-on: ubuntu-latest
    # if: ${{ inputs.lambda == true }}
    needs: prepare-builds
    steps:
      - name: Build Lambda Layer
        run: echo "Building Lambda layer..."

  build-glue:
    name: ğŸ› ï¸ Glue Script
    runs-on: ubuntu-latest
    # if: ${{ inputs.glue == true }}
    needs: prepare-builds
    steps:
      - name: Package Glue Script
        run: echo "Packaging Glue script..."

  build-state-machine:
    name: ğŸ› ï¸ State Machine
    runs-on: ubuntu-latest
    # if: ${{ inputs.state-machine == true }}
    needs: prepare-builds
    steps:
      - name: Deploy State Machine
        run: echo "Deploying State Machine..."

  ci-build:
    name: ğŸ“¦ CI Build
    runs-on: ubuntu-latest
    if: always()
    needs:
      - build-lambda
      - build-lambda-layer
      - build-glue
      - build-state-machine
    steps:
      - name: Finalize CI Build
        run: echo "CI build completed regardless of individual builds."

  infra-cost:
    name: ğŸ’° Infra Cost
    runs-on: ubuntu-latest
    if: always()
    needs: ci-build
    steps:
      - name: Determine Infra Cost
        run: echo "Determine Infra Cost."

  release-button:
    name: ğŸš€ Create Release button
    runs-on: ubuntu-latest
    if: always()
    needs: infra-cost
    steps:
      - name: Create Release Button
        run: echo "Create Release Button."
